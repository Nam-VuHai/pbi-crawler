# CAP-PowerBI-Crawler

## Components
### cap-pbi-crawler
* An Azure Container Instance that browse PowerBI PROD dashboards and generate/upload dashboard data (permissions and related reports) to storage account `cappowerbimonitorstor`.
* Using generated data to compare with previous-run data to find changes, send to Teams E2E channel if any.
* This container is short lived program that terminates itself when finished.
* Automatically pull image `pbicrawler:latest` from `cmrcapwus2acr`.

### Service principal and service account
* Service principal `cap-powerbi-crawler` to pull image from acr `cmrcapwus2acr` 
  * ACR Pull role in acr `cmrcapwus2acr` 
  * Secret stored in `capenginfrakv` with name `cap-powerbi-crawler-appsecret`
* Service account `svccappi` which has access to CAP PowerBI tenant
  * Password stored in `capenginfrakv` with name `svccappi`

### cmrcapwus2acr
* An Azure container Registry that host the image of cap-pbi-crawler.
* [ACR task](https://github.com/CAPInfrastructure/CAP-PowerBI-Crawler/blob/master/acr-tasks.yml) is used to build, push images from this repo and purge old images.

### CAPInfraAutomationAccount2/PBICrawlerTrigger
* An Automation Account runbook that start ACI `cap-pbi-crawler` using provided [REST API](https://docs.microsoft.com/en-us/rest/api/container-instances/containergroups/start).
* CAPInfraAutomationAccount2 requires `Contributor` role of ACI `cap-pbi-crawler`
* Scheduled to run once a day.

### cap-powerbi-monitor
* An Azure Function that triggered by queue `report-changes` in storage account `cappowerbimonitorstor`
* Comparing updated .pbix file in queue message to json file in container to find related dashboard. Then posts a notification to Teams E2E channel.

### pbi-dashboard-notification
* An Azure Logic App that watches Sharepoint PowerBI report files for any newly created/updated files.
* Create a new message to queue `report-changes` in storage account `cappowerbimonitorstor`

### cappowerbimonitorstor
* Storage account that hosts azure function, data generated by crawler, queue for pbix file change, and mounted volume in file shares.
* Storage account connection string stored in `capenginfrakv` with name `cappowerbimonitorstor`

## Setup
* Create github token (or use existing ones) for ACR to create webhooks for every commit/push to master.
* Disable the automatic generated webhook for pull request since we always build and push the latest image.
* Create a ACR task using [acr-tasks.yml](https://github.com/CAPInfrastructure/CAP-PowerBI-Crawler/blob/master/acr-tasks.yml) to build, push, and purge images.
```
az acr task create --name pbicrawlercicd -f acr-tasks.yml -r 'cmrcapwus2acr' -c 'https://github.com/CAPInfrastructure/CAP-PowerBI-Crawler.git' --git-access-token <github-token> --subscription "CMR CAP Public Cloud - SVC MGMT"
```
* Create a ACI using [deploy.ps1](https://github.com/CAPInfrastructure/CAP-PowerBI-Crawler/blob/master/deploy.ps1)
  * Require set access policy to ACI if last az cli command stuck
  * Put storage account key to mount fileshare for debugging if needed

## Teams Notification
* Notifications sent to CAPS E2E channel when there is a change in permissions, related reports (from `cap-pbi-crawler`) and .pbix files (created, updated from `cap-powerbi-monitor`)
* Exceptions sent to Infra channel when a failure or exception happens

## Cheatsheet
* Trigger ACR task
```
az acr task run --registry acrtestne --name taskpbicrawlercicd --subscription "CMR CAP Public Cloud - SVC MGMT"
```
* Start ACI container
```
az container start --resource-group "cap-powerbi-monitor" --name "cap-pbi-crawler" --subscription "CMR CAP Public Cloud - SVC MGMT"
```
* View ACI logs:
```
az container logs --resource-group "cap-powerbi-monitor" --name "cap-pbi-crawler" --subscription "CMR CAP Public Cloud - SVC MGMT"
```
* ACI deployment yaml reference: https://docs.microsoft.com/en-us/azure/container-instances/container-instances-reference-yaml

## Debugging
* Check logs to see errors, it's wise to take screenshots if a crawling step fails
* Put storage account key to mount fileshare for debugging
* Check mounted volume (same storage file shares) /data for logs/screenshots

## Notes:
* The only ways to start/stop ACI are to use Azure CLI or REST API. AzureRM or Az module do not support this.
* Automation account do not support Azure CLI.
* ACI can pull images from ACR automatically but does not start the container afterward.
* Azure Functions doesn't support Puppeeter :(
